<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Data Entry Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Great+Vibes&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
`   <base target="_self">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --blue: #1e3a8a;
            --blue-dark: #1e40af;
            --gray-bg: #f3f6fa;
            --text-gray: #4b5563;
            --white: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gray-bg);
            color: var(--text-gray);
            margin: 0;
        }

        .header {
            background: var(--blue);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            flex-wrap: wrap;
            position: fixed; /* Keep header at top */
            width: 100%;
            top: 0;
            left: 0;
            z-index: 500; /* Ensure it's above other content */
        }

        .header .brand {
            font-weight: 600;
            font-size: 20px;
        }
        .choices {
            width: 100%;
            font-size: 18px; /* Match input font size */
            color: #1e3a8a; /* Match input text color */
            font-weight: bold; /* Match input font weight */
        }

        .choices__inner {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: white;
            min-height: auto; /* Prevent extra height */
            display: flex; /* Make it a flex container */
            align-items: center; /* Vertically center content */
        }

        .choices__list--single .choices__item {
            padding: 0; /* Remove default padding */
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis for long text */
        }

        .choices__list--single {
            padding: 0; /* Remove padding from the container of the selected item */
        }

        /* Style the dropdown arrow */
        .choices[data-type*="select-one"]::after {
            content: '';
            height: 0;
            width: 0;
            border-style: solid;
            border-width: 5px 5px 0 5px;
            border-color: #333 transparent transparent transparent; /* Darker arrow */
            position: absolute;
            right: 11px; /* Adjust position */
            top: 50%;
            margin-top: -2.5px;
            pointer-events: none;
        }

        /* Hide the default dropdown arrow if present */
        .choices[data-type*="select-one"] .choices__inner {
            padding-right: 10px; /* Reset original padding if it adds space for native arrow */
        }

        /* Style the options list (when dropdown is open) */
        .choices__list--dropdown {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 5px;
            z-index: 10; /* Ensure it's above other elements */
        }

        .choices__list--dropdown .choices__item {
            padding: 8px 10px;
            font-size: 15px; /* Match standard select size */
            color: #4b5563; /* Default text color for options */
        }

        .choices__list--dropdown .choices__item--selectable.is-highlighted {
            background-color: #e0ecff; /* Highlight color on hover/focus */
            color: var(--blue); /* Text color for highlighted item */
        }

        /* Style the search input within Choices.js */
        .choices__input {
            background-color: white;
            border: none; /* Remove border from internal input */
            padding: 10px;
            font-size: 15px;
            color: #1e3a8a;
            box-sizing: border-box;
            width: 100%;
        }

        /* Fix for Choices.js default padding on choices__list--single */
        .choices__list.choices__list--single {
            padding-left: 0;
        }
        .search-filter {
            display: flex;
            align-items: center;
            margin-left: auto;
            max-width: 320px;
            width: 100%;
        }

        .search-form {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 2px 6px;
            width: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-left: -33px; /* Adjusted to match your original layout */
        }

        .filter-group {
            display: flex;
            align-items: center;
            border-right: 1px solid #ccc;
            padding-right: 6px;
            margin-right: 6px;
            color: black;
        }

        .filter-icon {
            width: 18px;
            height: 18px;
            color: #555;
        }

        .filter-select {
            border: none;
            background: transparent;
            font-size: 12px;
            color: #444;
            outline: none;
            padding: 4px;
            cursor: pointer;
            max-width: 70px;
        }

        .search-form input {
            border: none;
            outline: none;
            font-size: 14px;
            padding: 6px 8px;
            flex: 1;
            color: var(--text-gray);
        }

        .search-form button {
            background:white ;
            color: #1e3a8a;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 27px; /* Adjusted to match your original layout */
        }

        .sidebar {
    background: #1e3a8a; /* --blue variable */
    width: 200px;
    padding: 20px 12px;
    color: white;
    position: fixed;
    top: 66px;
    bottom: 0;
    left: 0;
    overflow-y: auto;
}

.sidebar a {
    color: white;
    text-decoration: none;
    padding: 12px;
    display: flex;
    align-items: center;
    font-size: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    transition: background-color 0.3s ease;
}

.sidebar a.active {
    background: #1e40af; /* --blue-dark variable */
    font-weight: 600;
}

.sidebar a svg {
    margin-right: 7px;
    stroke-width: 1.5;
}

.sidebar a:hover {
    background: #334155;
}


        .main {
            margin-left: 230px; /* Adjusted for new sidebar width */
            padding: 30px;
            padding-top: 90px; /* Space for the fixed header */
        }

        .welcome-container {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 30px;
            margin-top:26px;
        }

        .welcome {
            font-family: 'Great Vibes', cursive;
            font-size: 53px;
            color: var(--blue-dark);
        }

        .username {
            font-weight: 600;
            font-size: 26px;
        }

        .grid-nameds {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .named {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .named h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #6b7280;
        }

        .named p {
            font-size: 24px;
            font-weight: bold;
            color: var(--blue);
        }

        .shortcuts h2 {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .shortcut-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
        }

        .shortcut {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: background-color 0.3s ease; /* Added transition for hover effect */
        }

        .shortcut:hover {
            background: #e0ecff;
        }

        .shortcut i {
            margin-bottom: 10px;
        }

        .shortcut span {
            font-weight: 600;
            display: block;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center; /* Center horizontally */
            align-items: center; /* Vertically center content */
        }

        .modal-content {
            background-color: #fff;
            margin: 60px auto; /* Adjusted margin for better centering */
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 700px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
            position: relative; /* Needed for close-btn absolute positioning */
        }

        h2.modal-title {
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-btn {
            color: #aaa;
            position: absolute; /* Position relative to modal-content */
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full {
            grid-column: span 2;
        }

        label {
            font-weight: 500;
            margin-bottom: 6px;
        }
        /* Apply to all inputs */
        input[type="text"],
        input[type="date"],
        input[type="number"],
        select { /* Added select here */
            width: 100%;
            padding: 10px;
            font-size: 18px;
            color: #1e3a8a; /* Dark blue */
            border: 1px solid #ccc;
            border-radius: 6px; /* Changed from 66px to 6px */
            box-sizing: border-box;
            font-weight: bold;
            background-color: white; /* Ensure consistent background for selects */
        }


        /* Make readonly and disabled consistent too */
        input[readonly],
        input[disabled] {
            background-color: #f3f6fa;
            color: #1e3a8a;
        }

        .modal-footer {
            margin-top: 25px;
            text-align: center;
        }

        .view-more-btn {
            padding: 10px 25px;
            font-size: 14px;
            font-weight: 600;
            background-color: #e0ecff;
            color: var(--blue);
            border: 1px solid var(--blue);
            border-radius: 8px;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .view-more-btn:hover {
            background-color: var(--blue);
            color: white;
        }


        button[type="submit"] {
            padding: 14px 40px;
            font-size: 17px;
            font-weight: 600;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        button[type="submit"]:hover {
            background-color: #1e40af;
        }

        /* Styles for conversion message */
        .conversion-status {
            font-size: 12px;
            color: #2563eb; /* Blue color for status */
            margin-top: 4px;
            display: none; /* Hidden by default */
        }
        .conversion-status.error {
            color: #dc2626; /* Red for errors */
        }

        /* Sales Table Specific Styles (Re-applied with new theme variables) */
        .sales-table-container {
            background-color: var(--white);
            padding: 20px;
            border-radius: 12px; /* Consistent with other elements */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); /* Consistent with other elements */
            margin-top: 30px;
        }

        .sales-table-container h2 {
            color: var(--text-gray); /* Match text-gray */
            font-size: 20px; /* Consistent with other h2s */
            margin-top: 0;
            margin-bottom: 15px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .sales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
            min-width: 850px; /* Adjusted to fit the new columns */
        }

        .sales-table thead tr {
            background-color: var(--blue); /* Use theme blue for header */
            color: white;
            text-align: left;
        }

        .sales-table th,
        .sales-table td {
            padding: 12px 15px;
            border: 1px solid #ddd;
        }

        .sales-table th {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sales-table tbody tr:nth-child(even) {
            background-color: #f9f9f9; /* Lighter shade for zebra striping */
        }

        .sales-table tbody tr:hover {
            background-color: #e0ecff; /* Highlight color on hover */
        }

        .sales-table tbody tr .edit-icon {
            opacity: 0.2;
            cursor: pointer;
            transition: opacity 0.2s ease-in-out;
        }
        /* Style for the edit button within the table */
        .sales-table .edit-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 6px 10px;
            background-color: #e0ecff; /* Light blue background */
            color: var(--blue); /* Dark blue text */
            border: 1px solid var(--blue);
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background-color 0.3s ease, color 0.3s ease;
            text-decoration: none; /* Remove underline for anchor if used */
        }

        .sales-table .edit-button:hover {
            background-color: var(--blue);
            color: white;
        }

        .sales-table .edit-button svg {
            width: 16px;
            height: 16px;
            stroke-width: 2;
        }


        /* Custom confirmation message box styles */
        .message-box-confirm .content {
            background-color: white;
            padding: 25px 35px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 400px;
            text-align: center;
        }

        .message-box-confirm .content p {
            margin: 0 0 20px 0;
            font-size: 16px;
            color: #1e3a8a;
            font-weight: 600;
        }

        .message-box-confirm .button-group {
            display: flex;
            gap: 15px;
        }

        .message-box-confirm .button-group button {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .message-box-confirm .button-group button.yes-button {
            background-color: #2563eb;
            color: white;
        }

        .message-box-confirm .button-group button.yes-button:hover {
            background-color: #1e40af;
        }

        .message-box-confirm .button-group button.no-button {
            background-color: #e0e0e0;
            color: #333;
        }

        .message-box-confirm .button-group button.no-button:hover {
            background-color: #c0c0c0;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar {
                display: none; /* As per your provided media query */
            }

            .main {
                margin-left: 0;
                padding: 20px;
                padding-top: 90px; /* Still need space for fixed header if it's not hidden */
            }

            .header {
                flex-direction: column;
                align-items: stretch;
                padding: 15px;
                position: static; /* Allow header to flow with content on mobile */
            }

            .search-filter {
                flex-direction: column;
                align-items: stretch;
                margin-left: 0;
                width: 100%;
            }

            .search-form {
                margin-left: 0; /* Reset margin for mobile */
            }

            .search-form button {
                margin-left: 0; /* Reset margin for mobile */
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-group.full {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="brand">üìò My Dashboard</div>
    </div>

<div class="sidebar">
    <a href="https://script.google.com/macros/s/AKfycbzGKZOrFVLSDvpPGGrGHR_x2BXNBrKiU_of-WlJPw-P/dev" class="active"  target="self"><i data-lucide="layout-dashboard"></i>Dashboard</a>
    <a href="https://script.google.com/macros/s/AKfycbzGKZOrFVLSDvpPGGrGHR_x2BXNBrKiU_of-WlJPw-P/dev?page=sales" target="self">
    <i data-lucide="shopping-cart"></i>Sales</a>
    <a href="#"><i data-lucide="package"></i>Purchase</a>
    <a href="#"><i data-lucide="file-text"></i>VAT</a>
    <a href="#"><i data-lucide="book-open"></i>Ledger</a>
    <a href="#"><i data-lucide="calendar"></i>Reports</a>
    <a href="#"><i data-lucide="bar-chart-2"></i>Analytics</a>
</div>


    <div class="main">
        <div class="welcome-container">
            <div class="welcome">Welcome,</div>
            <div class="username">Pratyush Dulal</div>
        </div>

        <div class="grid-nameds">
            <div class="named"><h3>Monthly‚Äôs Sales</h3><p>Rs. 12,500</p></div>
            <div class="named"><h3>Monthly‚Äôs Purchases</h3><p>Rs. 8,200</p></div>
            <div class="named"><h3>Net Cash</h3><p>Rs. 4,300</p></div>
            <div class="named"><h3>Pending Invoices</h3><p>3</p></div>
        </div>

        <div class="shortcuts">
            <h2>Quick Actions</h2>
            <div class="shortcut-grid">
                <div class="shortcut" onclick="openSalesModal()">
                    <i data-lucide="file-plus"></i><span>New Sale</span>
                </div>
                <div class="shortcut" onclick="openPurchaseModal()">
                    <i data-lucide="shopping-bag"></i><span>New Purchase</span>
                </div>
                <div class="shortcut" onclick="openVatModal()">
                    <i data-lucide="file-text"></i><span>New VAT</span>
                </div>
                <div class="shortcut" id="viewSalesShortcut" onclick="toggleViewSalesTable()">
                    <i data-lucide="list"></i><span>View Sales</span>
                </div>
                <div class="shortcut" id="viewPurchasesShortcut" onclick="toggleViewPurchaseTable()">
                    <i data-lucide="archive"></i><span>View Purchases</span>
                </div>
                <div class="shortcut" id="viewVatShortcut" onclick="toggleViewVatTable()">
                    <i data-lucide="layers"></i><span>View VAT</span>
                </div>
                </div>
        </div>

        <div class="sales-table-container" id="salesTableContainer" style="display: none;">
            <h2>Recent Sales Entries</h2>
            <div class="table-responsive">
                <table class="sales-table">
                    <thead>
                        <tr>
                            <th>SN</th>
                            <th>Bill No</th>
                            <th>Date (AD)</th>
                            <th>Date (BS)</th>
                            <th>Name</th>
                            <th>PAN No</th>
                            <th>Sales Amount</th>
                            <th>VAT Amount</th>
                            <th>Total</th>
                            <th>Edit</th> 
                        </tr>
                    </thead>
                    <tbody id="salesTableBody">
                        </tbody>
                </table>
            </div>
            <div class="modal-footer" id="viewMoreContainer" style="display: none; margin-top: 15px;">
                <button id="viewMoreBtn" class="view-more-btn">View More Results</button>
            </div>
        </div>

        <div class="sales-table-container" id="purchaseTableContainer" style="display: none;">
            <h2>Recent Purchase Entries</h2>
            <div class="table-responsive">
                <table class="sales-table">
                    <thead>
                        <tr>
                            <th>SN</th>
                            <th>Bill No</th>
                            <th>Date (AD)</th>
                            <th>Date (BS)</th>
                            <th>Supplier Name</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>VAT</th>
                            <th>Total</th>
                            <th>Edit</th>
                        </tr>
                    </thead>
                    <tbody id="purchaseTableBody">
                    </tbody>
                </table>
            </div>
            <div class="modal-footer" id="viewMorePurchaseContainer" style="display: none; margin-top: 15px;">
                <button id="viewMorePurchaseBtn" class="view-more-btn">View More Results</button>
            </div>
        </div>

        <div class="sales-table-container" id="vatTableContainer" style="display: none;">
            <h2>Recent VAT Entries</h2>
            <div class="table-responsive">
                <table class="sales-table">
                    <thead>
                        <tr>
                            <th>SN</th>
                            <th>PAN Number</th>
                            <th>Name</th>
                            <th>Edit</th>
                        </tr>
                    </thead>
                    <tbody id="vatTableBody">
                    </tbody>
                </table>
            </div>
            <div class="modal-footer" id="viewMoreVatContainer" style="display: none; margin-top: 15px;">
                <button id="viewMoreVatBtn" class="view-more-btn">View More Results</button>
            </div>
        </div>
        <div class="modal" id="salesModal">
            <div class="modal-content">
                <span class="close-btn" onclick="closeSalesModal()">&times;</span>
                <h2 class="modal-title"><i data-lucide="book-open-check"></i> Sales Entry</h2>
                <form id="salesForm">
                    <input type="hidden" id="isEditMode" value="false" />
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="sn">SN</label><input type="text" id="sn" name="sn" value="170" readonly />
                        </div>
                        <div class="form-group">
                            <label for="billNumber">Bill No</label>
                            <input type="number" id="billNumber" name="billNumber" required />
                        </div>
                        <div class="form-group">
                            <label for="dateAD">English Date</label>
                            <input type="date" id="dateAD" name="dateAD" required />
                            <span id="adConversionStatus" class="conversion-status"></span>
                        </div>
                        <div class="form-group">
                            <label for="dateBS">Nepali Date</label>
                            <input type="text" id="dateBS" name="dateBS" placeholder="YYYY-MM-DD" required />
                            <span id="bsConversionStatus" class="conversion-status"></span>
                        </div>
                        <div class="form-group">
                            <label for="clientName">Name</label>
                            <select id="clientName" name="clientName" required></select>
                        </div>

                        <div class="form-group">
                            <label for="panNumber">PAN No</labeL>
                            <input type="text" id="panNumber" name="panNumber" disabled />
                        </div>

                        <div class="form-group">
                            <label for="amount">Sales Amount</label>
                            <input type="text" id="amount" name="amount" required />
                        </div>
                        <div class="form-group">
                            <label for="vatAmount">VAT Amount (13%)</label>
                            <input type="text" id="vatAmount" name="vatAmount" disabled />
                        </div>
                        <div class="form-group full">
                            <label for="total">Total (with VAT)</label>
                            <input type="text" id="total" name="total" readonly />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" id="saveButton">üíæ Save</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal" id="purchaseModal">
            <div class="modal-content">
                <span class="close-btn" onclick="closePurchaseModal()">&times;</span>
                <h2 class="modal-title"><i data-lucide="shopping-cart"></i> Purchase Entry</h2>
                <form id="purchaseForm">
                    <input type="hidden" id="isPurchaseEditMode" value="false" />
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="purchaseSn">SN</label>
                            <input type="text" id="purchaseSn" name="purchaseSn" value="170" readonly />
                        </div>
                        <div class="form-group">
                            <label for="purchaseBillNumber">Bill No</label>
                            <input type="number" id="purchaseBillNumber" name="purchaseBillNumber" required />
                        </div>
                        <div class="form-group">
                            <label for="purchaseDateAD">English Date</label>
                            <input type="date" id="purchaseDateAD" name="purchaseDateAD" required />
                            <span id="purchaseAdConversionStatus" class="conversion-status"></span>
                        </div>
                        <div class="form-group">
                            <label for="purchaseDateBS">Nepali Date</label>
                            <input
                                type="text"
                                id="purchaseDateBS"
                                name="purchaseDateBS"
                                placeholder="YYYY-MM-DD"
                                required
                            />
                            <span id="purchaseBsConversionStatus" class="conversion-status"></span>
                        </div>
                        <div class="form-group">
                            <label for="supplierName">Name</label>
                            <select id="supplierName" name="supplierName" required></select>
                        </div>

                        <div class="form-group">
                            <label for="supplierPanNumber">PAN No</labeL>
                            <input type="text" id="supplierPanNumber" name="supplierPanNumber" disabled />
                        </div>

                        <div class="form-group">
                            <label for="purchaseType">Purchase Type</label>
                            <select id="purchaseType" name="purchaseType" required>
                                <option value="">-- Select Type --</option>
                                <option value="Non vat">Non VAT</option>
                                <option value="Expenses">Expenses</option>
                                <option value="Fixed assets">Fixed Assets</option>
                                <option value="Purchase">Purchase (Goods)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="purchaseAmount">Purchase Amount</label>
                            <input type="text" id="purchaseAmount" name="purchaseAmount" required />
                        </div>

                        <div class="form-group">
                            <label for="purchaseVatAmount">VAT Amount (13%)</label>
                            <input type="text" id="purchaseVatAmount" name="purchaseVatAmount" readonly />
                        </div>
                        <div class="form-group">
                            <label for="purchaseTotal">Total (with VAT)</label>
                            <input type="text" id="purchaseTotal" name="purchaseTotal" readonly />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" id="savePurchaseButton">üíæ Save</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal" id="vatModal">
            <div class="modal-content">
                <span class="close-btn" onclick="closeVatModal()">&times;</span>
                <h2 class="modal-title"><i data-lucide="file-text"></i> VAT No Entry Form</h2>
                <form id="vatForm">
                    <input type="hidden" id="isVatEditMode" value="false" />
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="vatSn">Serial Number:</label>
                            <input type="text" id="vatSn" name="vatSn" readonly />
                        </div>
                        <div class="form-group">
                            <label for="vatPanNumber">9-digit PAN Number:</label>
                            <input
                                type="text"
                                id="vatPanNumber"
                                name="vatPanNumber"
                                placeholder="Enter 9-digit PAN"
                                maxlength="9"
                                required
                            />
                            <span id="panCheckStatus" class="conversion-status"></span>
                        </div>
                        <div class="form-group full">
                            <label for="vatName">Name:</label>
                            <input
                                type="text"
                                id="vatName"
                                name="vatName"
                                placeholder="Auto or manual input"
                                required
                            />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" id="saveVatButton">üíæ Save Data</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();
            
            // --- Global Variables ---
            let clientMap = {};
            let choicesInstance;
            let supplierMap = {};
            let purchaseChoicesInstance;
            

            // --- Sales Modal Elements ---
            const salesModal = document.getElementById("salesModal");
            const amountInput = document.getElementById("amount");
            const vatInput = document.getElementById("vatAmount");
            const totalInput = document.getElementById("total");
            const snInput = document.getElementById("sn");
            const salesForm = document.getElementById("salesForm");
            const saveSalesBtn = document.getElementById("saveButton");
            const salesStatusMsg = document.createElement("div");
            salesStatusMsg.style.marginTop = "10px";
            salesStatusMsg.style.color = "#16a34a";
            salesStatusMsg.style.fontWeight = "600";
            salesStatusMsg.style.display = "none";
            salesForm.querySelector(".modal-footer").appendChild(salesStatusMsg);

            // Sales Date conversion elements
            const dateADInput = document.getElementById("dateAD");
            const dateBSInput = document.getElementById("dateBS");
            const adConversionStatus = document.getElementById("adConversionStatus");
            const bsConversionStatus = document.getElementById("bsConversionStatus");
            
            // Sales Table and "View More" Elements
            const salesTableContainer = document.getElementById("salesTableContainer");
            const salesTableBody = document.getElementById("salesTableBody");
            const viewMoreContainer = document.getElementById("viewMoreContainer");
            const viewMoreBtn = document.getElementById("viewMoreBtn");
            let recordsToShow = 10;


            // --- Purchase Modal Elements ---
            const purchaseModal = document.getElementById("purchaseModal");
            const purchaseSnInput = document.getElementById("purchaseSn");
            const purchaseBillNumberInput = document.getElementById("purchaseBillNumber");
            const purchaseDateADInput = document.getElementById("purchaseDateAD");
            const purchaseDateBSInput = document.getElementById("purchaseDateBS");
            const purchaseAdConversionStatus = document.getElementById("purchaseAdConversionStatus");
            const purchaseBsConversionStatus = document.getElementById("purchaseBsConversionStatus");
            const supplierNameSelect = document.getElementById("supplierName");
            const supplierPanNumberInput = document.getElementById("supplierPanNumber");
            const purchaseTypeSelect = document.getElementById("purchaseType");
            const purchaseAmountInput = document.getElementById("purchaseAmount");
            const purchaseVatAmountInput = document.getElementById("purchaseVatAmount");
            const purchaseTotalInput = document.getElementById("purchaseTotal");
            const purchaseForm = document.getElementById("purchaseForm");
            const savePurchaseBtn = purchaseForm.querySelector("button[type='submit']");
            const purchaseStatusMsg = document.createElement("div");
            let purchaseRecordsToShow = 10;
            purchaseStatusMsg.style.marginTop = "10px";
            purchaseStatusMsg.style.color = "#16a34a";
            purchaseStatusMsg.style.fontWeight = "600";
            purchaseStatusMsg.style.display = "none";
            purchaseForm.querySelector(".modal-footer").appendChild(purchaseStatusMsg);

            // --- VAT Modal Elements ---
            const vatModal = document.getElementById("vatModal");
            const vatSnInput = document.getElementById("vatSn");
            const vatPanNumberInput = document.getElementById("vatPanNumber");
            const vatNameInput = document.getElementById("vatName");
            const vatForm = document.getElementById("vatForm");
            const saveVatButton = document.getElementById("saveVatButton");
            const panCheckStatus = document.getElementById("panCheckStatus");
            const vatStatusMsg = document.createElement("div");
            vatStatusMsg.style.marginTop = "10px";
            vatStatusMsg.style.color = "#16a34a";
            vatStatusMsg.style.fontWeight = "600";
            vatStatusMsg.style.display = "none";
            vatForm.querySelector(".modal-footer").appendChild(vatStatusMsg);
            
            // START OF CHANGE: VAT Table and "View More" Elements
            const vatTableContainer = document.getElementById("vatTableContainer");
            const vatTableBody = document.getElementById("vatTableBody");
            const viewMoreVatContainer = document.getElementById("viewMoreVatContainer");
            const viewMoreVatBtn = document.getElementById("viewMoreVatBtn");
            let vatRecordsToShow = 10;
            // END OF CHANGE


            // Helper function to format numbers with commas
            function formatNumber(num) {
                if (isNaN(num) || num === null || num === undefined) {
                    return "";
                }
                return Number(num).toLocaleString("en-IN", {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }

            // Helper function to format ISO date string to YYYY-MM-DD
            function formatDateToYYYYMMDD(isoDateString) {
                if (!isoDateString) return '';
                const datePart = String(isoDateString).split('T')[0];
                return datePart;
            }

            // --- Sales Table Logic ---
            window.toggleViewSalesTable = function() {
                const viewSalesShortcut = document.getElementById("viewSalesShortcut");
                const isVisible = salesTableContainer.style.display === "block";

                if (!isVisible) {
                    recordsToShow = 10; // Reset count when opening
                    salesTableContainer.style.display = "block";
                    viewSalesShortcut.querySelector("span").textContent = "Hide Sales";
                    loadClients().then(() => {
                        loadSalesRecords(recordsToShow);
                    });
                } else {
                    salesTableContainer.style.display = "none";
                    viewMoreContainer.style.display = "none";
                    viewSalesShortcut.querySelector("span").textContent = "View Sales";
                    salesTableBody.innerHTML = '';
                }
            }

            function loadSalesRecords(count) {
                if (count <= 10) {
                    salesTableBody.innerHTML = `<tr><td colspan="10" style="text-align:center;">Loading recent sales records...</td></tr>`;
                }
                viewMoreBtn.textContent = "Loading...";

                google.script.run
                    .withSuccessHandler(function(records) {
                        if (count <= 10) salesTableBody.innerHTML = ''; 

                        if (!records || records.length === 0) {
                            salesTableBody.innerHTML = `<tr><td colspan="10" style="text-align:center;">No recent sales records found.</td></tr>`;
                            viewMoreContainer.style.display = "none"; 
                            return;
                        }
                        
                        // To prevent duplicating rows on "View More", clear the table body only for the initial load.
                        if (count <= 10) {
                           salesTableBody.innerHTML = '';
                        } else {
                           // For subsequent loads, we append, so we find where to start.
                           const existingRows = salesTableBody.rows.length;
                           records = records.slice(existingRows);
                        }


                        records.forEach(rowData => {
                            const row = salesTableBody.insertRow();
                            row.insertCell().textContent = rowData[0]; // SN
                            row.insertCell().textContent = rowData[1]; // Bill No
                            row.insertCell().textContent = formatDateToYYYYMMDD(rowData[2]); // Date (AD)
                            row.insertCell().textContent = rowData[3]; // Date (BS)
                            row.insertCell().textContent = rowData[4]; // Name
                            row.insertCell().textContent = rowData[5]; // PAN No
                            row.insertCell().textContent = 'Rs. ' + formatNumber(rowData[6]); // Sales Amount 
                            row.insertCell().textContent = 'Rs. ' + formatNumber(rowData[7]); // VAT 
                            row.insertCell().textContent = 'Rs. ' + formatNumber(rowData[8]); // Total 
                            
                            const actionCell = row.insertCell();
                            actionCell.style.textAlign = 'center';
                            actionCell.innerHTML = `<button class="edit-button"><i data-lucide="edit-2"></i>Edit</button>`;
                            const editButton = actionCell.querySelector('.edit-button');
                            lucide.createIcons({ nodes: [editButton.querySelector('svg')] });

                            editButton.addEventListener('click', () => {
                                confirmEditSalesRecord(rowData);
                            });
                        });
                        
                        viewMoreContainer.style.display = "block";
                        viewMoreBtn.textContent = "View More Results";
                        viewMoreBtn.style.display = (records.length < 5 && count > 10) ? 'none' : 'inline-block';

                    })
                    .withFailureHandler(function(error) {
                        console.error("Error loading sales records:", error);
                        salesTableBody.innerHTML = `<tr><td colspan="10" style="color:red; text-align:center;">Error loading records: ${error.message}</td></tr>`;
                        viewMoreBtn.textContent = "View More Results";
                    })
                    .getRecentSalesRecords(count);
            }

            function confirmEditSalesRecord(rowData) {
                const billNo = rowData[1];
                const message = `Do you want to edit sales voucher no ${billNo}?`;

                displayConfirmBox(message, () => {
                    editSalesRecord(rowData);
                });
            }


            function editSalesRecord(rowData) {
                const [sn, billNo, dateAD, dateBS, clientName, panNumber, salesAmount, vatAmount, totalAmount] = rowData;

                openSalesModal(true).then(() => { 
                    document.getElementById('sn').value = sn;
                    document.getElementById('billNumber').value = billNo;
                    document.getElementById('dateAD').value = formatDateToYYYYMMDD(dateAD);
                    document.getElementById('dateBS').value = dateBS;
                    
                    if (choicesInstance) {
                      choicesInstance.setChoiceByValue(String(clientName ||'').trim());
                    } 

                    document.getElementById('panNumber').value = panNumber;
                    document.getElementById('amount').value = formatNumber(salesAmount); 
                    document.getElementById('vatAmount').value = formatNumber(vatAmount);
                    document.getElementById('total').value = formatNumber(totalAmount);

                    updateSalesVAT();
                });
            }
            
            viewMoreBtn.addEventListener('click', function() {
                recordsToShow += 5;
                loadSalesRecords(recordsToShow);
            });


            // --- Sales Form Logic ---
            function updateSalesVAT() {
                let rawValue = amountInput.value.replace(/,/g, "");
                let amount = parseFloat(rawValue);
                if (!isNaN(amount)) {
                    let vat = amount * 0.13;
                    let total = amount + vat;
                    vatInput.value = formatNumber(vat);
                    totalInput.value = formatNumber(total);
                } else {
                    vatInput.value = "";
                    totalInput.value = "";
                    if (rawValue === "") {
                        amountInput.value = "";
                    }
                }
            }
            amountInput.addEventListener("input", updateSalesVAT);
            amountInput.addEventListener("blur", function() {
                let rawValue = this.value.replace(/,/g, "");
                let amount = parseFloat(rawValue);
                if (!isNaN(amount) && rawValue !== "") {
                    this.value = formatNumber(amount);
                } else if (rawValue === "") {
                    this.value = ""; 
                }
            });


            function loadNextSalesSN() {
                google.script.run.withSuccessHandler(sn => {
                    snInput.value = sn;
                }).getNextSN();
            }

            salesForm.addEventListener("submit", function (e) {
                e.preventDefault();
                saveSalesBtn.disabled = true;

                const isUpdate = document.getElementById("isEditMode").value === 'true';
                saveSalesBtn.textContent = isUpdate ? "Updating..." : "Saving...";
                salesStatusMsg.style.display = "none";

                const data = {
                    sn: snInput.value,
                    billNumber: document.getElementById("billNumber").value,
                    dateAD: dateADInput.value,
                    dateBS: dateBSInput.value,
                    clientName: document.getElementById("clientName").value,
                    panNumber: document.getElementById("panNumber").value,
                    amount: amountInput.value.replace(/,/g, ""),
                    vatAmount: vatInput.value.replace(/,/g, ""),
                    total: totalInput.value.replace(/,/g, "")
                };

                function resetSaveButton() {
                    saveSalesBtn.disabled = false;
                    saveSalesBtn.textContent = isUpdate ? 'üîÑ Update & Save' : 'üíæ Save';
                }

                const successCallback = (response) => {
                    const successMessage = isUpdate ? "‚úÖ Updated successfully" : "‚úÖ Saved successfully";
                    
                    if (isUpdate) {
                        displayMessageBox(successMessage, 'info');
                        setTimeout(() => {
                            closeSalesModal();
                            loadSalesRecords(recordsToShow); 
                        }, 1500);
                    } else {
                        salesForm.reset();
                        vatInput.value = "";
                        totalInput.value = "";
                        document.getElementById("panNumber").value = "";
                        if (choicesInstance) choicesInstance.destroy();
                        loadClients();
                        adConversionStatus.style.display = "none";
                        bsConversionStatus.style.display = "none";
                        salesStatusMsg.textContent = successMessage;
                        salesStatusMsg.style.display = "block";
                        loadNextSalesSN();
                        if (salesTableContainer.style.display === "block") {
                            loadSalesRecords(recordsToShow);
                        }
                    }
                    resetSaveButton();
                };

                const failureCallback = (err) => {
                    const action = isUpdate ? "update" : "save";
                    displayMessageBox(`‚ùå Couldn't ${action} data: ${err.message}`, "error");
                    resetSaveButton();
                };

                if (isUpdate) {
                    google.script.run
                        .withSuccessHandler(successCallback)
                        .withFailureHandler(failureCallback)
                        .updateSalesEntry(data);
                } else {
                    google.script.run
                        .withSuccessHandler(successCallback)
                        .withFailureHandler(failureCallback)
                        .submitSalesEntry(data);
                }
            });

            window.openSalesModal = async function (isEdit = false) { 
                document.getElementById("isEditMode").value = isEdit;
                salesModal.style.display = "flex";

                if (!isEdit) {
                    loadNextSalesSN();
                    dateADInput.value = '';
                    dateBSInput.value = '';
                }
                
                await loadClients();

                saveSalesBtn.textContent = isEdit ? 'üîÑ Update & Save' : 'üíæ Save';
                adConversionStatus.style.display = "none";
                bsConversionStatus.style.display = "none";
            };

            window.closeSalesModal = function () {
                salesModal.style.display = "none";
                salesStatusMsg.style.display = "none";
                salesForm.reset();
                if (choicesInstance) {
                    choicesInstance.destroy(); 
                }
                document.getElementById("panNumber").value = "";
                amountInput.value = "";
                vatInput.value = "";
                totalInput.value = "";
                document.getElementById("isEditMode").value = 'false';
                saveSalesBtn.textContent = "üíæ Save";
                adConversionStatus.style.display = "none";
                bsConversionStatus.style.display = "none";
            };


            dateADInput.addEventListener("change", function() {
                const adDate = this.value;
                if (adDate) {
                    bsConversionStatus.style.display = "block";
                    bsConversionStatus.textContent = "Converting date...";
                    bsConversionStatus.classList.remove("error");
                    google.script.run
                        .withSuccessHandler(bsDate => {
                            if (bsDate) {
                                dateBSInput.value = bsDate;
                                bsConversionStatus.style.display = "none";
                            } else {
                                dateBSInput.value = "";
                                bsConversionStatus.textContent = "Date not found in ADTOBS.";
                                bsConversionStatus.classList.add("error");
                            }
                        })
                        .withFailureHandler(err => {
                            dateBSInput.value = "";
                            bsConversionStatus.textContent = "Error converting: " + err.message;
                            bsConversionStatus.classList.add("error");
                        })
                        .convertADtoBS(adDate);
                } else {
                    dateBSInput.value = "";
                    bsConversionStatus.style.display = "none";
                }
            });

            dateBSInput.addEventListener("change", function() {
                const bsDate = this.value;
                const datePattern = /^\d{4}-\d{2}-\d{2}$/;
                if (bsDate && datePattern.test(bsDate)) {
                    adConversionStatus.style.display = "block";
                    adConversionStatus.textContent = "Converting date...";
                    adConversionStatus.classList.remove("error");
                    google.script.run
                        .withSuccessHandler(adDate => {
                            if (adDate) {
                                dateADInput.value = adDate; 
                                adConversionStatus.style.display = "none";
                            } else {
                                adConversionStatus.textContent = "Date not found in ADTOBS.";
                                adConversionStatus.classList.add("error");
                            }
                        })
                        .withFailureHandler(err => {
                            dateADInput.value = ""; 
                            adConversionStatus.textContent = "Error converting: " + err.message;
                            adConversionStatus.classList.add("error");
                        })
                        .convertBStoAD(bsDate);
                } else {
                    dateADInput.value = "";
                    adConversionStatus.style.display = "none";
                    if (bsDate && !datePattern.test(bsDate)) {
                        adConversionStatus.style.display = "block";
                        adConversionStatus.textContent = "Invalid format. Use YYYY-MM-DD.";
                        adConversionStatus.classList.add("error");
                    }
                }
            });

            function loadClients() {
                return new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler(function(clientData) {
                        const select = document.getElementById("clientName");
                        if (choicesInstance) {
                            choicesInstance.destroy(); 
                        }
                        select.innerHTML = "";
                        clientMap = {};

                        select.appendChild(new Option('-- Select Client --', ''));

                        clientData.forEach(function([name, pan]) {
                            if (name && pan) {
                                select.appendChild(new Option(name, name));
                                clientMap[name] = pan;
                            }
                        });

                        choicesInstance = new Choices(select, {
                            searchEnabled: true,
                            itemSelectText: "",
                            shouldSort: false
                        });

                        select.addEventListener("change", function () {
                            document.getElementById("panNumber").value = clientMap[this.value] || "";
                        });
                        resolve();

                    }).withFailureHandler(reject).getClientList();
                });
            }

            // --- Purchase Form Logic ---
            function updatePurchaseVAT() {
                let rawValue = purchaseAmountInput.value.replace(/,/g, "");
                let amount = parseFloat(rawValue);

                const selectedPurchaseType = purchaseTypeSelect.value;
                if (!isNaN(amount)) {
                    if (selectedPurchaseType === "Non vat") {
                        purchaseVatAmountInput.value = formatNumber(0);
                        purchaseTotalInput.value = formatNumber(amount);
                    } else {
                        let vat = amount * 0.13;
                        let total = amount + vat;
                        purchaseVatAmountInput.value = formatNumber(vat);
                        purchaseTotalInput.value = formatNumber(total);
                    }
                } else {
                    purchaseVatAmountInput.value = "";
                    purchaseTotalInput.value = "";
                    if (rawValue === "") {
                        purchaseAmountInput.value = "";
                    }
                }
            }
            purchaseAmountInput.addEventListener("input", updatePurchaseVAT);
            purchaseAmountInput.addEventListener("blur", function() {
                let rawValue = this.value.replace(/,/g, "");
                let amount = parseFloat(rawValue);
                if (!isNaN(amount) && rawValue !== "") {
                    this.value = formatNumber(amount);
                } else if (rawValue === "") {
                    this.value = "";
                }
            });
            purchaseTypeSelect.addEventListener("change", updatePurchaseVAT);

            function loadNextPurchaseSN() {
                google.script.run.withSuccessHandler(sn => {
                    purchaseSnInput.value = sn;
                }).getNextPurchaseSN();
            }

            function loadSuppliers() {
                return new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(function(supplierData) {
                            const select = document.getElementById("supplierName");
                            if (purchaseChoicesInstance) {
                                purchaseChoicesInstance.destroy();
                            }
                            select.innerHTML = "";
                            supplierMap = {};
                            select.appendChild(new Option("-- Select Supplier --", ""));
                            supplierData.forEach(function([name, pan]) {
                                if (name && pan) {
                                    select.appendChild(new Option(name, name));
                                    supplierMap[name] = pan;
                                }
                            });
                            purchaseChoicesInstance = new Choices(select, {
                                searchEnabled: true,
                                itemSelectText: "",
                                shouldSort: false,
                            });
                            select.addEventListener("change", function() {
                                supplierPanNumberInput.value = supplierMap[this.value] || "";
                            });
                            resolve(); 
                        })
                        .withFailureHandler(reject) 
                        .getClientList();
                });
            }

            // --- Purchase Table Logic ---
            window.toggleViewPurchaseTable = function() {
                const purchaseTableContainer = document.getElementById("purchaseTableContainer");
                const viewPurchasesShortcut = document.getElementById("viewPurchasesShortcut");
                const isVisible = purchaseTableContainer.style.display === "block";

                if (!isVisible) {
                    purchaseRecordsToShow = 10; 
                    purchaseTableContainer.style.display = "block";
                    viewPurchasesShortcut.querySelector("span").textContent = "Hide Purchases";
                    loadPurchaseRecords(purchaseRecordsToShow);
                } else {
                    purchaseTableContainer.style.display = "none";
                    document.getElementById("viewMorePurchaseContainer").style.display = "none";
                    viewPurchasesShortcut.querySelector("span").textContent = "View Purchases";
                    document.getElementById("purchaseTableBody").innerHTML = '';
                }
            }

            function loadPurchaseRecords(count) {
                const purchaseTableBody = document.getElementById("purchaseTableBody");
                const viewMorePurchaseBtn = document.getElementById("viewMorePurchaseBtn");
                const viewMorePurchaseContainer = document.getElementById("viewMorePurchaseContainer");

                if (count <= 10) {
                    purchaseTableBody.innerHTML = `<tr><td colspan="10" style="text-align:center;">Loading recent purchase records...</td></tr>`;
                }
                viewMorePurchaseBtn.textContent = "Loading...";
                viewMorePurchaseBtn.disabled = true;

                google.script.run
                    .withSuccessHandler(function(records) {
                        if (count <= 10) purchaseTableBody.innerHTML = ''; 

                        if (!records || records.length === 0) {
                            purchaseTableBody.innerHTML = `<tr><td colspan="10" style="text-align:center;">No recent purchase records found.</td></tr>`;
                            viewMorePurchaseContainer.style.display = "none"; 
                            return;
                        }

                        records.forEach(rowData => {
                            const row = purchaseTableBody.insertRow();
                            let purchaseAmount = 0;
                            const purchaseType = rowData[10]; 
                            switch (purchaseType) {
                                case 'Purchase': purchaseAmount = rowData[9]; break;
                                case 'Expenses': purchaseAmount = rowData[7]; break;
                                case 'Fixed assets': purchaseAmount = rowData[8]; break;
                                case 'Non vat': purchaseAmount = rowData[6]; break;
                            }
                            row.insertCell().textContent = rowData[0]; // SN
                            row.insertCell().textContent = rowData[1]; // Bill No
                            row.insertCell().textContent = formatDateToYYYYMMDD(rowData[2]); // Date (AD)
                            row.insertCell().textContent = rowData[3]; // Date (BS)
                            row.insertCell().textContent = rowData[4]; // Supplier Name
                            row.insertCell().textContent = rowData[10]; // Purchase Type
                            row.insertCell().textContent = 'Rs. ' + formatNumber(purchaseAmount); // Purchase Amount
                            row.insertCell().textContent = 'Rs. ' + formatNumber(rowData[12]); // VAT
                            row.insertCell().textContent = 'Rs. ' + formatNumber(rowData[13]); // Total
                            
                            const actionCell = row.insertCell();
                            actionCell.style.textAlign = 'center';
                            actionCell.innerHTML = `<button class="edit-button"><i data-lucide="edit-2"></i>Edit</button>`;
                            const editButton = actionCell.querySelector('.edit-button');
                            lucide.createIcons({ nodes: [editButton.querySelector('svg')] });

                            editButton.addEventListener('click', () => {
                                confirmEditPurchaseRecord(rowData);
                            });
                        });
                        
                        viewMorePurchaseContainer.style.display = "block";
                        viewMorePurchaseBtn.textContent = "View More Results";
                        viewMorePurchaseBtn.disabled = false;
                        viewMorePurchaseBtn.style.display = (records.length < count) ? 'none' : 'inline-block';
                    })
                    .withFailureHandler(function(error) {
                        console.error("Error loading purchase records:", error);
                        purchaseTableBody.innerHTML = `<tr><td colspan="10" style="color:red; text-align:center;">Error loading records: ${error.message}</td></tr>`;
                        viewMorePurchaseBtn.textContent = "View More Results";
                        viewMorePurchaseBtn.disabled = false;
                    })
                    .getRecentPurchaseRecords(count);
            }
            
            document.getElementById('viewMorePurchaseBtn').addEventListener('click', function() {
                purchaseRecordsToShow += 5;
                loadPurchaseRecords(purchaseRecordsToShow);
            });

            function confirmEditPurchaseRecord(rowData) {
                const billNo = rowData[1];
                const message = `Do you want to edit purchase voucher no ${billNo}?`;

                displayConfirmBox(message, () => {
                    editPurchaseRecord(rowData);
                });
            }

            async function editPurchaseRecord(rowData) {
                await openPurchaseModal(true);
                const [sn, billNo, dateAD, dateBS, supplierName, panNumber, nonVat, expenses, fixedAssets, purchase, purchaseType, totalTaxable, vat, total] = rowData;

                let amount = 0;
                switch (purchaseType) {
                    case "Non vat": amount = nonVat; break;
                    case "Expenses": amount = expenses; break;
                    case "Fixed assets": amount = fixedAssets; break;
                    case "Purchase": amount = purchase; break;
                }

                purchaseSnInput.value = sn;
                purchaseBillNumberInput.value = billNo;
                purchaseDateADInput.value = formatDateToYYYYMMDD(dateAD);
                purchaseDateBSInput.value = dateBS;
                purchaseTypeSelect.value = purchaseType;

                if (purchaseChoicesInstance) {
                    purchaseChoicesInstance.setChoiceByValue(String(supplierName || "").trim());
                }

                supplierPanNumberInput.value = panNumber || ""; 

                purchaseAmountInput.value = formatNumber(amount);
                purchaseVatAmountInput.value = formatNumber(vat);
                purchaseTotalInput.value = formatNumber(total);
            }

            purchaseForm.addEventListener("submit", function (e) {
                e.preventDefault();
                savePurchaseBtn.disabled = true;

                const isUpdate = document.getElementById("isPurchaseEditMode").value === 'true';
                savePurchaseBtn.textContent = isUpdate ? "Updating..." : "Saving...";
                purchaseStatusMsg.style.display = "none";

                const data = {
                    sn: purchaseSnInput.value,
                    billNumber: purchaseBillNumberInput.value,
                    dateAD: purchaseDateADInput.value,
                    dateBS: purchaseDateBSInput.value,
                    supplierName: supplierNameSelect.value,
                    supplierPanNumber: supplierPanNumberInput.value,
                    purchaseType: purchaseTypeSelect.value,
                    purchaseAmount: purchaseAmountInput.value.replace(/,/g, ""),
                    vatAmount: purchaseVatAmountInput.value.replace(/,/g, ""),
                    total: purchaseTotalInput.value.replace(/,/g, "")
                };

                function resetSaveButton() {
                    savePurchaseBtn.disabled = false;
                    savePurchaseBtn.textContent = isUpdate ? 'üîÑ Update & Save' : 'üíæ Save';
                }

                const successCallback = () => {
                    if (isUpdate) {
                        displayMessageBox("‚úÖ Updated successfully", 'info');
                        setTimeout(() => {
                            closePurchaseModal();
                            loadPurchaseRecords(purchaseRecordsToShow);
                        }, 1500);
                    } else {
                        purchaseForm.reset();
                        purchaseVatAmountInput.value = "";
                        purchaseTotalInput.value = "";
                        purchaseAmountInput.value = "";
                        supplierPanNumberInput.value = "";
                        purchaseStatusMsg.textContent = "‚úÖ Saved successfully";
                        purchaseStatusMsg.style.display = "block";
                        loadNextPurchaseSN();
                        if (purchaseChoicesInstance) purchaseChoicesInstance.destroy();
                        loadSuppliers();
                        purchaseAdConversionStatus.style.display = "none";
                        purchaseBsConversionStatus.style.display = "none";
                        if (document.getElementById("purchaseTableContainer").style.display === "block") {
                            loadPurchaseRecords(purchaseRecordsToShow);
                        }
                    }
                    resetSaveButton();
                };

                const failureCallback = (err) => {
                    const action = isUpdate ? "update" : "save";
                    displayMessageBox(`‚ùå Couldn't ${action} data: ${err.message}`, "error");
                    resetSaveButton();
                };
                
                if (isUpdate) {
                    google.script.run
                        .withSuccessHandler(successCallback)
                        .withFailureHandler(failureCallback)
                        .updatePurchaseEntry(data);
                } else {
                    google.script.run
                        .withSuccessHandler(successCallback)
                        .withFailureHandler(failureCallback)
                        .submitPurchaseEntry(data);
                }
            });

            window.openPurchaseModal = async function(isEdit = false) {
                document.getElementById("isPurchaseEditMode").value = isEdit;
                purchaseModal.style.display = "flex";

                if (!isEdit) {
                    purchaseForm.reset();
                    loadNextPurchaseSN();
                    purchaseAmountInput.value = '';
                    purchaseVatAmountInput.value = '';
                    purchaseTotalInput.value = '';
                    purchaseTypeSelect.value = '';
                    supplierPanNumberInput.value = '';
                }

                savePurchaseBtn.textContent = isEdit ? "üîÑ Update & Save" : "üíæ Save";
                purchaseAdConversionStatus.style.display = "none";
                purchaseBsConversionStatus.style.display = "none";

                await loadSuppliers();
            };

            window.closePurchaseModal = function () {
                purchaseModal.style.display = "none";
                purchaseStatusMsg.style.display = "none";
                purchaseForm.reset();
                document.getElementById("isPurchaseEditMode").value = 'false';
                if (purchaseChoicesInstance) {
                    purchaseChoicesInstance.destroy();
                }
            };

            purchaseDateADInput.addEventListener("change", function() {
                const adDate = this.value;
                if (adDate) {
                    purchaseBsConversionStatus.style.display = "block";
                    purchaseBsConversionStatus.textContent = "Converting date...";
                    purchaseBsConversionStatus.classList.remove("error");
                    google.script.run
                        .withSuccessHandler(bsDate => {
                            if (bsDate) {
                                purchaseDateBSInput.value = bsDate;
                                purchaseBsConversionStatus.style.display = "none";
                            } else {
                                purchaseBsConversionStatus.value = "";
                                purchaseBsConversionStatus.textContent = "Date not found in ADTOBS.";
                                purchaseBsConversionStatus.classList.add("error");
                            }
                        })
                        .withFailureHandler(err => {
                            purchaseDateBSInput.value = "";
                            purchaseBsConversionStatus.textContent = "Error converting: " + err.message;
                            purchaseBsConversionStatus.classList.add("error");
                        })
                        .convertADtoBS(adDate);
                } else {
                    purchaseDateBSInput.value = "";
                    purchaseBsConversionStatus.style.display = "none";
                }
            });

            purchaseDateBSInput.addEventListener("change", function() {
                const bsDate = this.value;
                const datePattern = /^\d{4}-\d{2}-\d{2}$/;
                if (bsDate && datePattern.test(bsDate)) {
                    purchaseAdConversionStatus.style.display = "block";
                    purchaseAdConversionStatus.textContent = "Converting date...";
                    purchaseAdConversionStatus.classList.remove("error");
                    google.script.run
                        .withSuccessHandler(adDate => {
                            if (adDate) {
                                purchaseDateADInput.value = adDate;
                                purchaseAdConversionStatus.style.display = "none";
                            } else {
                                purchaseAdConversionStatus.textContent = "Date not found in ADTOBS.";
                                adConversionStatus.classList.add("error");
                            }
                        })
                        .withFailureHandler(err => {
                            purchaseDateADInput.value = "";
                            purchaseAdConversionStatus.textContent = "Error converting: " + err.message;
                            purchaseAdConversionStatus.classList.add("error");
                        })
                        .convertBStoAD(bsDate);
                } else {
                    purchaseDateADInput.value = "";
                    purchaseAdConversionStatus.style.display = "none";
                    if (bsDate && !datePattern.test(bsDate)) {
                        purchaseAdConversionStatus.style.display = "block";
                        purchaseAdConversionStatus.textContent = "Invalid format. Use YYYY-MM-DD.";
                        purchaseAdConversionStatus.classList.add("error");
                    }
                }
            });

            // --- VAT Entry Form Logic ---
            function loadNextVatSN() {
                google.script.run.withSuccessHandler(sn => {
                    vatSnInput.value = sn;
                }).getNextVatSN();
            }

            vatPanNumberInput.addEventListener("input", function() {
                const pan = this.value.trim();
                if (pan.length === 9 && !isNaN(pan)) {
                    panCheckStatus.style.display = "block";
                    panCheckStatus.textContent = "Checking PAN...";
                    panCheckStatus.classList.remove("error");
                    google.script.run
                        .withSuccessHandler(name => {
                            if (name) {
                                vatNameInput.value = name;
                                vatNameInput.readOnly = true;
                                panCheckStatus.style.display = "none";
                            } else {
                                vatNameInput.value = "";
                                vatNameInput.readOnly = false;
                                panCheckStatus.textContent = "PAN not found. Enter name manually.";
                                panCheckStatus.classList.remove("error");
                            }
                        })
                        .withFailureHandler(err => {
                            console.error("Error checking PAN:", err);
                            vatNameInput.value = "";
                            vatNameInput.readOnly = false;
                            panCheckStatus.textContent = "Error checking PAN: " + err.message;
                            panCheckStatus.classList.add("error");
                        })
                        .getClientNameByPan(pan);
                } else {
                    vatNameInput.value = "";
                    vatNameInput.readOnly = false;
                    panCheckStatus.style.display = "none";
                }
            });

            vatForm.addEventListener("submit", function(e) {
                e.preventDefault();
                saveVatButton.disabled = true;
                const isUpdate = document.getElementById("isVatEditMode").value === 'true';
                saveVatButton.textContent = isUpdate ? "Updating..." : "Saving...";
                vatStatusMsg.style.display = "none";

                const data = {
                    sn: vatSnInput.value,
                    panNumber: vatPanNumberInput.value,
                    name: vatNameInput.value
                };

                if (!data.panNumber || data.panNumber.length !== 9 || isNaN(data.panNumber)) {
                    displayMessageBox("‚ùå Please enter a valid 9-digit PAN number.", "error");
                    saveVatButton.disabled = false;
                    saveVatButton.textContent = isUpdate ? 'üîÑ Update & Save' : 'üíæ Save Data';
                    return;
                }
                if (!data.name) {
                    displayMessageBox("‚ùå Please enter a Name for the PAN entry.", "error");
                    saveVatButton.disabled = false;
                    saveVatButton.textContent = isUpdate ? 'üîÑ Update & Save' : 'üíæ Save Data';
                    return;
                }

                function resetSaveButton() {
                    saveVatButton.disabled = false;
                    saveVatButton.textContent = isUpdate ? 'üîÑ Update & Save' : 'üíæ Save Data';
                }

                const successCallback = () => {
                    if (isUpdate) {
                        displayMessageBox("‚úÖ Updated successfully", 'info');
                        setTimeout(() => {
                            closeVatModal();
                            loadVatRecords(vatRecordsToShow);
                        }, 1500);
                    } else {
                        vatForm.reset();
                        vatNameInput.readOnly = false;
                        vatStatusMsg.textContent = "‚úÖ VAT entry saved!";
                        vatStatusMsg.style.display = "block";
                        loadNextVatSN();
                        panCheckStatus.style.display = "none";
                         if (vatTableContainer.style.display === "block") {
                            loadVatRecords(vatRecordsToShow); 
                        }
                    }
                    resetSaveButton();
                };

                const failureCallback = (err) => {
                    const action = isUpdate ? "update" : "save";
                    displayMessageBox(`‚ùå Couldn't ${action} VAT data: ${err.message}`, "error");
                    resetSaveButton();
                };

                if (isUpdate) {
                    google.script.run
                        .withSuccessHandler(successCallback)
                        .withFailureHandler(failureCallback)
                        .updateVatEntry(data);
                } else {
                    google.script.run
                        .withSuccessHandler(successCallback)
                        .withFailureHandler(failureCallback)
                        .submitVatEntry(data);
                }
            });

            window.openVatModal = function (isEdit = false) {
                document.getElementById("isVatEditMode").value = isEdit;
                vatModal.style.display = "flex";
                saveVatButton.textContent = isEdit ? 'üîÑ Update & Save' : 'üíæ Save Data';

                if (!isEdit) {
                    vatForm.reset();
                    loadNextVatSN();
                    vatNameInput.readOnly = false;
                    panCheckStatus.style.display = "none";
                    vatStatusMsg.style.display = "none";
                }
            };

            window.closeVatModal = function () {
                vatModal.style.display = "none";
                vatForm.reset();
                document.getElementById("isVatEditMode").value = 'false';
                vatNameInput.readOnly = false;
                panCheckStatus.style.display = "none";
                vatStatusMsg.style.display = "none";
            };

            // START OF CHANGE: VAT Table Logic
            window.toggleViewVatTable = function() {
                const viewVatShortcut = document.getElementById("viewVatShortcut");
                const isVisible = vatTableContainer.style.display === "block";

                if (!isVisible) {
                    vatRecordsToShow = 10;
                    vatTableContainer.style.display = "block";
                    viewVatShortcut.querySelector("span").textContent = "Hide VAT";
                    loadVatRecords(vatRecordsToShow);
                } else {
                    vatTableContainer.style.display = "none";
                    viewMoreVatContainer.style.display = "none";
                    viewVatShortcut.querySelector("span").textContent = "View VAT";
                    vatTableBody.innerHTML = '';
                }
            }

            function loadVatRecords(count) {
                if (count <= 10) {
                    vatTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Loading recent VAT records...</td></tr>`;
                }
                viewMoreVatBtn.textContent = "Loading...";
                viewMoreVatBtn.disabled = true;

                google.script.run
                    .withSuccessHandler(function(records) {
                        if (count <= 10) vatTableBody.innerHTML = '';

                        if (!records || records.length === 0) {
                            vatTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No recent VAT records found.</td></tr>`;
                            viewMoreVatContainer.style.display = "none";
                            return;
                        }

                        records.forEach(rowData => {
                            const row = vatTableBody.insertRow();
                            row.insertCell().textContent = rowData[0]; // SN
                            row.insertCell().textContent = rowData[1]; // PAN Number
                            row.insertCell().textContent = rowData[2]; // Name

                            const actionCell = row.insertCell();
                            actionCell.style.textAlign = 'center';
                            actionCell.innerHTML = `<button class="edit-button"><i data-lucide="edit-2"></i>Edit</button>`;
                            const editButton = actionCell.querySelector('.edit-button');
                            lucide.createIcons({ nodes: [editButton.querySelector('svg')] });

                            editButton.addEventListener('click', () => {
                                confirmEditVatRecord(rowData);
                            });
                        });

                        viewMoreVatContainer.style.display = "block";
                        viewMoreVatBtn.textContent = "View More Results";
                        viewMoreVatBtn.disabled = false;
                        viewMoreVatBtn.style.display = (records.length < count) ? 'none' : 'inline-block';
                    })
                    .withFailureHandler(function(error) {
                        console.error("Error loading VAT records:", error);
                        vatTableBody.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center;">Error loading records: ${error.message}</td></tr>`;
                        viewMoreVatBtn.textContent = "View More Results";
                        viewMoreVatBtn.disabled = false;
                    })
                    .getRecentVatRecords(count);
            }

            viewMoreVatBtn.addEventListener('click', function() {
                vatRecordsToShow += 5;
                loadVatRecords(vatRecordsToShow);
            });

            function confirmEditVatRecord(rowData) {
                const pan = rowData[1];
                const message = `Do you want to edit the entry for PAN ${pan}?`;

                displayConfirmBox(message, () => {
                    editVatRecord(rowData);
                });
            }

            function editVatRecord(rowData) {
                const [sn, panNumber, name] = rowData;
                openVatModal(true);
                vatSnInput.value = sn;
                vatPanNumberInput.value = panNumber;
                vatNameInput.value = name;
            }
            // END OF CHANGE


            // Global click handler for modals and message box
            window.onclick = function (event) {
                const msgBox = document.getElementById("messageBox");
                if (event.target === salesModal) closeSalesModal();
                if (event.target === purchaseModal) closePurchaseModal();
                if (event.target === vatModal) closeVatModal();
                if (msgBox && event.target === msgBox && !event.target.closest('.message-box-confirm .content')) {
                    msgBox.remove();
                }
            };

            function displayMessageBox(message, type = "info") {
                let messageBox = document.getElementById("messageBox");
                if (messageBox) messageBox.remove();
                
                messageBox = document.createElement("div");
                messageBox.id = "messageBox";
                messageBox.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background-color: rgba(0,0,0,0.4); z-index: 1001;
                    display: flex; align-items: center; justify-content: center;
                `;

                const content = document.createElement('div');
                content.style.cssText = `
                    background-color: white; padding: 25px 35px; border-radius: 10px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    display: flex; flex-direction: column; align-items: center;
                    max-width: 400px; text-align: center;
                `;
                
                content.innerHTML = `
                    <p style="margin: 0 0 20px 0; font-size: 16px; color: ${type === 'error' ? '#dc2626' : '#1e3a8a'}; font-weight: 600;">${message}</p>
                    <button style="
                        padding: 10px 25px; background-color: #2563eb; color: white;
                        border: none; border-radius: 5px; cursor: pointer; font-size: 14px;
                    ">OK</button>
                `;
                
                content.querySelector('button').onclick = () => messageBox.remove();
                messageBox.appendChild(content);
                document.body.appendChild(messageBox);
            }

            function displayConfirmBox(message, onConfirm, onCancel) {
                let messageBox = document.getElementById("messageBox");
                if (messageBox) messageBox.remove(); 

                messageBox = document.createElement("div");
                messageBox.id = "messageBox";
                messageBox.classList.add("message-box-confirm"); 
                messageBox.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background-color: rgba(0,0,0,0.4); z-index: 1001;
                    display: flex; align-items: center; justify-content: center;
                `;

                const content = document.createElement('div');
                content.classList.add("content");
                
                content.innerHTML = `
                    <p>${message}</p>
                    <div class="button-group">
                        <button class="yes-button">Yes</button>
                        <button class="no-button">No</button>
                    </div>
                `;
                
                content.querySelector('.yes-button').onclick = () => {
                    messageBox.remove();
                    if (onConfirm) onConfirm();
                };
                content.querySelector('.no-button').onclick = () => {
                    messageBox.remove();
                    if (onCancel) onCancel();
                };

                messageBox.appendChild(content);
                document.body.appendChild(messageBox);
            }

        });
    </script>
</body>
</html>