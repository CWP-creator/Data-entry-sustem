<html lang="en">
<head>
<head>
  <meta charset="UTF-8" />
  <title>Data Entry Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Great+Vibes&display=swap" rel="stylesheet" />
  <!-- Choices.js CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

  <!-- Choices.js JS -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <script src="https://unpkg.com/lucide@latest"></script>

 <style>   :root {
            --blue: #1e3a8a;
            --blue-dark: #1e40af;
            --gray-bg: #f3f6fa;
            --text-gray: #4b5563;
            --white: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gray-bg);
            color: var(--text-gray);
            margin: 0;
        }

        .header {
            background: var(--blue);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 30px;
            flex-wrap: wrap;
        }

        .header .brand {
            font-weight: 600;
            font-size: 20px;
        }
        .choices {
            width: 100%;
            font-size: 18px; /* Match input font size */
            color: #1e3a8a; /* Match input text color */
            font-weight: bold; /* Match input font weight */
        }

        .choices__inner {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: white;
            min-height: auto; /* Prevent extra height */
            display: flex; /* Make it a flex container */
            align-items: center; /* Vertically center content */
        }

        .choices__list--single .choices__item {
            padding: 0; /* Remove default padding */
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis for long text */
        }

        .choices__list--single {
            padding: 0; /* Remove padding from the container of the selected item */
        }

        /* Style the dropdown arrow */
        .choices[data-type*="select-one"]::after {
            content: '';
            height: 0;
            width: 0;
            border-style: solid;
            border-width: 5px 5px 0 5px;
            border-color: #333 transparent transparent transparent; /* Darker arrow */
            position: absolute;
            right: 11px; /* Adjust position */
            top: 50%;
            margin-top: -2.5px;
            pointer-events: none;
        }

        /* Hide the default dropdown arrow if present */
        .choices[data-type*="select-one"] .choices__inner {
            padding-right: 10px; /* Reset original padding if it adds space for native arrow */
        }

        /* Style the options list (when dropdown is open) */
        .choices__list--dropdown {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 5px;
            z-index: 10; /* Ensure it's above other elements */
        }

        .choices__list--dropdown .choices__item {
            padding: 8px 10px;
            font-size: 15px; /* Match standard select size */
            color: #4b5563; /* Default text color for options */
        }

        .choices__list--dropdown .choices__item--selectable.is-highlighted {
            background-color: #e0ecff; /* Highlight color on hover/focus */
            color: var(--blue); /* Text color for highlighted item */
        }

        /* Style the search input within Choices.js */
        .choices__input {
            background-color: white;
            border: none; /* Remove border from internal input */
            padding: 10px;
            font-size: 15px;
            color: #1e3a8a;
            box-sizing: border-box;
            width: 100%;
        }

        /* Fix for Choices.js default padding on choices__list--single */
        .choices__list.choices__list--single {
            padding-left: 0;
        }
        .search-filter {
            display: flex;
            align-items: center;
            margin-left: auto;
            max-width: 320px;
            width: 100%;
        }

        .search-form {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 2px 6px;
            width: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-left: -33px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            border-right: 1px solid #ccc;
            padding-right: 6px;
            margin-right: 6px;
            color: black;
        }

        .filter-icon {
            width: 18px;
            height: 18px;
            color: #555;
        }

        .filter-select {
            border: none;
            background: transparent;
            font-size: 12px;
            color: #444;
            outline: none;
            padding: 4px;
            cursor: pointer;
            max-width: 70px;
        }

        .search-form input {
            border: none;
            outline: none;
            font-size: 14px;
            padding: 6px 8px;
            flex: 1;
            color: var(--text-gray);
        }

        .search-form button {
            background:white ;
            color: #1e3a8a;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 27px;
        }

        .sidebar {
            background: var(--blue);
            width: 200px;
            padding: 20px 12px;
            color: white;
            position: fixed;
            top: 66px;
            bottom: 0;
            left: 0;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            padding: 12px;
            display: flex;
            align-items: center;
            font-size: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .sidebar a svg {
            margin-right: 7px;
            stroke-width: 1.5;
        }

        .sidebar a:hover {
            background: #334155;
        }

        .main {
            margin-left: 230px;
            padding: 30px;
        }

        .welcome-container {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 30px;
        }

        .welcome {
            font-family: 'Great Vibes', cursive;
            font-size: 53px;
            color: var(--blue-dark);
        }

        .username {
            font-weight: 600;
            font-size: 26px;
        }

        .grid-nameds {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .named {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .named h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #6b7280;
        }

        .named p {
            font-size: 24px;
            font-weight: bold;
            color: var(--blue);
        }

        .shortcuts h2 {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .shortcut-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
        }

        .shortcut {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .shortcut:hover {
            background: #e0ecff;
        }

        .shortcut i {
            margin-bottom: 10px;
        }

        .shortcut span {
            font-weight: 600;
            display: block;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .main {
                margin-left: 0;
                padding: 20px;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-filter {
                flex-direction: column;
                align-items: stretch;
                margin-left: 0;
                width: 100%;
            }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fff;
            margin: 60px auto;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 700px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
        }

        h2.modal-title {
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full {
            grid-column: span 2;
        }

        label {
            font-weight: 500;
            margin-bottom: 6px;
        }
        /* Apply to all inputs */
        input[type="text"],
        input[type="date"],
        input[type="number"],
        select { /* Added select here */
            width: 100%;
            padding: 10px;
            font-size: 18px;
            color: #1e3a8a; /* Dark blue */
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-weight: bold;
            background-color: white; /* Ensure consistent background for selects */
        }


        /* Make readonly and disabled consistent too */
        input[readonly],
        input[disabled] {
            background-color: #f3f6fa;
            color: #1e3a8a;
        }

        .modal-footer {
            margin-top: 25px;
            text-align: center;
        }

        button[type="submit"] {
            padding: 14px 40px;
            font-size: 17px;
            font-weight: 600;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        button[type="submit"]:hover {
            background-color: #1e40af;
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-group.full {
                grid-column: span 1;
            }
        }

        /* Styles for conversion message */
        .conversion-status {
            font-size: 12px;
            color: #2563eb; /* Blue color for status */
            margin-top: 4px;
            display: none; /* Hidden by default */
        }
        .conversion-status.error {
            color: #dc2626; /* Red for errors */
        }</style>
</head>
<body>
  <div class="header">
    <div class="brand">📘 My Dashboard</div>
    <div class="search-filter">
      <form class="search-form" action="#" method="GET">
        <div class="filter-group">
          <i data-lucide="filter" class="filter-icon"></i>
          <select name="filter" class="filter-select">
            <option value="all">All</option>
            <option value="date">Date</option>
            <option value="amount">Amount</option>
            <option value="category">Category</option>
            <option value="type">Type</option>
          </select>
        </div>
        <input type="text" name="query" placeholder="Search..." />
        <button type="submit1"><i data-lucide="search" style="width:14px;height:14px;"></i></button>
      </form>
    </div>  
  </div>

  <div class="sidebar">
    <a href="#"><i data-lucide="shopping-namet"></i>Sales</a>
    <a href="#"><i data-lucide="package"></i>Purchase</a>
    <a href="#"><i data-lucide="file-text"></i>VAT</a>
    <a href="#"><i data-lucide="book-open"></i>Ledger</a>
    <a href="#"><i data-lucide="calendar"></i>Reports</a>
    <a href="#"><i data-lucide="bar-chart-2"></i>Analytics</a>
  </div>

<div class="main">
  <div class="welcome-container">
    <div class="welcome">Welcome,</div>
    <div class="username">Pratyush</div>
  </div>

  <div class="grid-nameds">
    <div class="named"><h3>Monthly’s Sales</h3><p>Rs. 12,500</p></div>
    <div class="named"><h3>Monthly’s Purchases</h3><p>Rs. 8,200</p></div>
    <div class="named"><h3>Net Cash</h3><p>Rs. 4,300</p></div>
    <div class="named"><h3>Pending Invoices</h3><p>3</p></div>
  </div>

  <div class="shortcuts">
    <h2>Quick Actions</h2>
    <div class="shortcut-grid">
      <div class="shortcut" onclick="openSalesModal()">
        <i data-lucide="file-plus"></i><span>New Sale</span>
      </div>
      <div class="shortcut" onclick="openPurchaseModal()">
        <i data-lucide="shopping-bag"></i><span>New Purchase</span>
      </div>
      <div class="shortcut" onclick="openVatModal()">
        <i data-lucide="file-text"></i><span>New VAT</span>
      </div>
      <div class="shortcut" id="viewSalesShortcut" onclick="toggleViewSalesTable()">
        <i data-lucide="list"></i><span>View Sales</span>
      </div>
      <div class="shortcut">
        <i data-lucide="archive"></i><span>View Purchases</span>
      </div>
      <div class="shortcut">
        <i data-lucide="layers"></i><span>View VAT</span>
      </div>
    </div>
  </div>

  <div class="sales-table-container" id="salesTableContainer" style="display: none;">
    <h2>Recent Sales Entries</h2>
    <div class="table-responsive">
      <table class="sales-table">
        <thead>
          <tr>
            <th>SN</th>
            <th>Bill No</th>
            <th>Client Name</th>
            <th>Date (AD)</th>
            <th>Sales Amount</th>
            <th>VAT Amount</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="salesTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <div class="modal" id="salesModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeSalesModal()">&times;</span>
      <h2 class="modal-title"><i data-lucide="book-open-check"></i> Sales Entry</h2>
      <form id="salesForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="sn">SN</label><input type="text" id="sn" name="sn" value="170" readonly />
          </div>
          <div class="form-group">
            <label for="billNumber">Bill No</label
            ><input type="number" id="billNumber" name="billNumber" required />
          </div>
          <div class="form-group">
            <label for="dateAD">English Date</label>
            <input type="date" id="dateAD" name="dateAD" required />
            <span id="adConversionStatus" class="conversion-status"></span>
          </div>
          <div class="form-group">
            <label for="dateBS">Nepali Date</label>
            <input type="text" id="dateBS" name="dateBS" placeholder="YYYY-MM-DD" required />
            <span id="bsConversionStatus" class="conversion-status"></span>
          </div>
          <div class="form-group">
            <label for="clientName">Name</label>
            <select id="clientName" name="clientName" required></select>
          </div>

          <div class="form-group">
            <label for="panNumber">PAN No</labeL>
            <input type="text" id="panNumber" name="panNumber" disabled />
          </div>

          <div class="form-group">
            <label for="amount">Sales Amount</label
            ><input type="text" id="amount" name="amount" required />
          </div>
          <div class="form-group">
            <label for="vatAmount">VAT Amount (13%)</label
            ><input type="text" id="vatAmount" name="vatAmount" disabled />
          </div>
          <div class="form-group full">
            <label for="total">Total (with VAT)</label
            ><input type="text" id="total" name="total" readonly />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" id="saveButton">💾 Save</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="purchaseModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closePurchaseModal()">&times;</span>
      <h2 class="modal-title"><i data-lucide="shopping-cart"></i> Purchase Entry</h2>
      <form id="purchaseForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="purchaseSn">SN</label
            ><input type="text" id="purchaseSn" name="purchaseSn" value="170" readonly />
          </div>
          <div class="form-group">
            <label for="purchaseBillNumber">Bill No</label
            ><input type="number" id="purchaseBillNumber" name="purchaseBillNumber" required />
          </div>
          <div class="form-group">
            <label for="purchaseDateAD">English Date</label>
            <input type="date" id="purchaseDateAD" name="purchaseDateAD" required />
            <span id="purchaseAdConversionStatus" class="conversion-status"></span>
          </div>
          <div class="form-group">
            <label for="purchaseDateBS">Nepali Date</label>
            <input
              type="text"
              id="purchaseDateBS"
              name="purchaseDateBS"
              placeholder="YYYY-MM-DD"
              required
            />
            <span id="purchaseBsConversionStatus" class="conversion-status"></span>
          </div>
          <div class="form-group">
            <label for="supplierName">Name</label>
            <select id="supplierName" name="supplierName" required></select>
            </div>

          <div class="form-group">
            <label for="supplierPanNumber">PAN No</labeL>
            <input type="text" id="supplierPanNumber" name="supplierPanNumber" disabled />
            </div>

          <div class="form-group">
            <label for="purchaseType">Purchase Type</label>
            <select id="purchaseType" name="purchaseType" required>
              <option value="">-- Select Type --</option>
              <option value="Non vat">Non VAT</option>
              <option value="Expenses">Expenses</option>
              <option value="Fixed assets">Fixed Assets</option>
              <option value="Purchase">Purchase (Goods)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="purchaseAmount">Purchase Amount</label>
            <input type="text" id="purchaseAmount" name="purchaseAmount" required />
          </div>

          <div class="form-group">
            <label for="purchaseVatAmount">VAT Amount (13%)</label
            ><input type="text" id="purchaseVatAmount" name="purchaseVatAmount" readonly />
          </div>
          <div class="form-group">
            <label for="purchaseTotal">Total (with VAT)</label
            ><input type="text" id="purchaseTotal" name="purchaseTotal" readonly />
            </div>
        </div>
        <div class="modal-footer">
          <button type="submit" id="savePurchaseButton">💾 Save</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="vatModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeVatModal()">&times;</span>
      <h2 class="modal-title"><i data-lucide="file-text"></i> VAT No Entry Form</h2>
      <form id="vatForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="vatSn">Serial Number:</label>
            <input type="text" id="vatSn" name="vatSn" readonly />
          </div>
          <div class="form-group">
            <label for="vatPanNumber">9-digit PAN Number:</label>
            <input
              type="text"
              id="vatPanNumber"
              name="vatPanNumber"
              placeholder="Enter 9-digit PAN"
              maxlength="9"
              required
            />
            <span id="panCheckStatus" class="conversion-status"></span>
          </div>
          <div class="form-group full">
            <label for="vatName">Name:</label>
            <input
              type="text"
              id="vatName"
              name="vatName"
              placeholder="Auto or manual input"
              required
            />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" id="saveVatButton">💾 Save Data</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
/>

  <!-- Embedded JavaScript -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
      lucide.createIcons();

      // --- Sales Modal Elements ---
      const amountInput = document.getElementById("amount");
      const vatInput = document.getElementById("vatAmount");
      const totalInput = document.getElementById("total");
      const snInput = document.getElementById("sn");
      const salesForm = document.getElementById("salesForm");
      const saveSalesBtn = salesForm.querySelector("button[type='submit']");
      const salesStatusMsg = document.createElement("div");
      salesStatusMsg.style.marginTop = "10px";
      salesStatusMsg.style.color = "#16a34a";
      salesStatusMsg.style.fontWeight = "600";
      salesStatusMsg.style.display = "none";
      salesForm.querySelector(".modal-footer").appendChild(salesStatusMsg);

      // Sales Date conversion elements
      const dateADInput = document.getElementById("dateAD");
      const dateBSInput = document.getElementById("dateBS");
      const adConversionStatus = document.getElementById("adConversionStatus");
      const bsConversionStatus = document.getElementById("bsConversionStatus");
      const salesTableContainer = document.getElementById("salesTableContainer");

      // --- Purchase Modal Elements ---
      const purchaseModal = document.getElementById("purchaseModal");
      const purchaseSnInput = document.getElementById("purchaseSn");
      const purchaseBillNumberInput = document.getElementById("purchaseBillNumber");
      const purchaseDateADInput = document.getElementById("purchaseDateAD");
      const purchaseDateBSInput = document.getElementById("purchaseDateBS");
      const purchaseAdConversionStatus = document.getElementById("purchaseAdConversionStatus");
      const purchaseBsConversionStatus = document.getElementById("purchaseBsConversionStatus");
      const supplierNameSelect = document.getElementById("supplierName"); // Changed to select
      const supplierPanNumberInput = document.getElementById("supplierPanNumber");
      const purchaseTypeSelect = document.getElementById("purchaseType");
      const purchaseAmountInput = document.getElementById("purchaseAmount"); // New input for base amount
      const purchaseVatAmountInput = document.getElementById("purchaseVatAmount");
      const purchaseTotalInput = document.getElementById("purchaseTotal");
      const purchaseForm = document.getElementById("purchaseForm");
      const savePurchaseBtn = purchaseForm.querySelector("button[type='submit']");
      const purchaseStatusMsg = document.createElement("div");
      purchaseStatusMsg.style.marginTop = "10px";
      purchaseStatusMsg.style.color = "#16a34a";
      purchaseStatusMsg.style.fontWeight = "600";
      purchaseStatusMsg.style.display = "none";
      purchaseForm.querySelector(".modal-footer").appendChild(purchaseStatusMsg);

      // --- VAT Modal Elements - NEW ---
      const vatModal = document.getElementById("vatModal");
      const vatSnInput = document.getElementById("vatSn");
      const vatPanNumberInput = document.getElementById("vatPanNumber");
      const vatNameInput = document.getElementById("vatName");
      const vatForm = document.getElementById("vatForm");
      const saveVatButton = document.getElementById("saveVatButton");
      const panCheckStatus = document.getElementById("panCheckStatus");
      const vatStatusMsg = document.createElement("div");
      vatStatusMsg.style.marginTop = "10px";
      vatStatusMsg.style.color = "#16a34a";
      vatStatusMsg.style.fontWeight = "600";
      vatStatusMsg.style.display = "none";
      vatForm.querySelector(".modal-footer").appendChild(vatStatusMsg);


      function formatNumber(num) {
        if (isNaN(num) || num === null || num === undefined) {
            return "";
        }
        return Number(num).toLocaleString("en-IN");
      }


// Temporarily modify for frontend testing
// Temporarily modify for frontend testing
function toggleViewSalesTable() {
  const container = document.getElementById("salesTableContainer");
  const tableBody = document.getElementById("salesTableBody");
  const viewSalesShortcut = document.getElementById("viewSalesShortcut");

  if (container.style.display === "none") {
    // Simulate data if not using Apps Script backend
    tableBody.innerHTML = `
      <tr><td>1</td><td>1001</td><td>Client A</td><td>2025-07-01</td><td>Rs. 1,000.00</td><td>Rs. 130.00</td><td>Rs. 1,130.00</td></tr>
      <tr><td>2</td><td>1002</td><td>Client B</td><td>2025-07-02</td><td>Rs. 2,000.00</td><td>Rs. 260.00</td><td>Rs. 2,260.00</td></tr>
      <tr><td colspan="7" style="text-align:center;">More data here...</td></tr>
    `;
    container.style.display = "block";
    viewSalesShortcut.querySelector("span").textContent = "Hide Sales";
  } else {
    container.style.display = "none";
    viewSalesShortcut.querySelector("span").textContent = "View Sales";
  }

} // --- Sales Form Logic ---
      function updateSalesVAT() {
        let rawValue = amountInput.value.replace(/,/g, "");
        let amount = parseFloat(rawValue);
        if (!isNaN(amount)) {
          let vat = amount * 0.13;
          let total = amount + vat;
          vatInput.value = formatNumber(vat.toFixed(2));
          totalInput.value = formatNumber(total.toFixed(2));
          amountInput.value = formatNumber(amount.toFixed(2));
        } else {
          vatInput.value = "";
          totalInput.value = "";
          amountInput.value = "";
        }
      }
      amountInput.addEventListener("input", updateSalesVAT);

      function loadNextSalesSN() {
        google.script.run.withSuccessHandler(sn => {
          snInput.value = sn;
        }).getNextSN(); // Assuming getNextSN is for sales
      }

      salesForm.addEventListener("submit", function (e) {
        e.preventDefault();

        saveSalesBtn.disabled = true;
        saveSalesBtn.textContent = "Saving...";
        salesStatusMsg.style.display = "none";

        const data = {
          sn: document.getElementById("sn").value,
          billNumber: document.getElementById("billNumber").value,
          dateAD: document.getElementById("dateAD").value,
          dateBS: document.getElementById("dateBS").value,
          clientName: document.getElementById("clientName").value,
          panNumber: document.getElementById("panNumber").value,
          amount: document.getElementById("amount").value,
          vatAmount: document.getElementById("vatAmount").value,
          total: document.getElementById("total").value
        };

        google.script.run
          .withSuccessHandler(() => {
            salesForm.reset();
            vatInput.value = "";
            totalInput.value = "";
            document.getElementById("panNumber").value = "";
            saveSalesBtn.disabled = false;
            saveSalesBtn.textContent = "💾 Save";
            salesStatusMsg.textContent = "✅ Saved successfully";
            salesStatusMsg.style.display = "block";
            loadNextSalesSN();
            if (choicesInstance) {
                choicesInstance.destroy();
            }
            loadClients(); // Reload clients to reset dropdown
            adConversionStatus.style.display = "none";
            bsConversionStatus.style.display = "none";
          })
          .withFailureHandler(err => {
            displayMessageBox("❌ Couldn't save data: " + err.message, "error");
            saveSalesBtn.disabled = false;
            saveSalesBtn.textContent = "💾 Save";
          })
          .submitSalesEntry(data);
      });

      window.openSalesModal = function () {
        document.getElementById("salesModal").style.display = "block";
        loadNextSalesSN();
        loadClients();
        dateADInput.value = '';
        dateBSInput.value = '';
        adConversionStatus.style.display = "none";
        bsConversionStatus.style.display = "none";
      };

      window.closeSalesModal = function () {
        document.getElementById("salesModal").style.display = "none";
        salesStatusMsg.style.display = "none";
        if (choicesInstance) {
          choicesInstance.destroy();
        }
        document.getElementById("panNumber").value = "";
        salesForm.reset();
        amountInput.value = ""; // Clear amount input
        vatInput.value = "";
        totalInput.value = "";
        adConversionStatus.style.display = "none";
        bsConversionStatus.style.display = "none";
        const msgBox = document.getElementById("messageBox");
        if (msgBox) msgBox.remove();
      };

      // Sales Date conversion event listeners
      dateADInput.addEventListener("change", function() {
        const adDate = this.value;
        if (adDate) {
          bsConversionStatus.style.display = "block";
          bsConversionStatus.textContent = "Converting date...";
          bsConversionStatus.classList.remove("error");
          google.script.run
            .withSuccessHandler(bsDate => {
              if (bsDate) {
                dateBSInput.value = bsDate;
                bsConversionStatus.style.display = "none";
              } else {
                dateBSInput.value = ""; // Clear BS date if not found
                bsConversionStatus.textContent = "Date not found in ADTOBS.";
                bsConversionStatus.classList.add("error");
              }
            })
            .withFailureHandler(err => {
              dateBSInput.value = ""; // Clear BS date on error
              bsConversionStatus.textContent = "Error converting: " + err.message;
              bsConversionStatus.classList.add("error");
            })
            .convertADtoBS(adDate);
        } else {
          dateBSInput.value = ""; // Clear BS date if AD date is cleared
          bsConversionStatus.style.display = "none";
        }
      });

      dateBSInput.addEventListener("change", function() {
        const bsDate = this.value;
        const datePattern = /^\d{4}-\d{2}-\d{2}$/; // Strictly enforce YYYY-MM-DD
        if (bsDate && datePattern.test(bsDate)) {
          adConversionStatus.style.display = "block";
          adConversionStatus.textContent = "Converting date...";
          adConversionStatus.classList.remove("error");
          google.script.run
            .withSuccessHandler(adDate => {
              if (adDate) {
                dateADInput.value = adDate; // Assign to dateADInput, not adConversionStatus.value
                adConversionStatus.style.display = "none";
              } else {
                dateADInput.value = ""; // Clear AD date if not found
                adConversionStatus.textContent = "Date not found in ADTOBS.";
                adConversionStatus.classList.add("error");
              }
            })
            .withFailureHandler(err => {
              dateADInput.value = ""; // Clear AD date on error
              adConversionStatus.textContent = "Error converting: " + err.message;
              adConversionStatus.classList.add("error");
            })
            .convertBStoAD(bsDate);
        } else {
          dateADInput.value = ""; // Clear AD date if BS date is cleared or invalid
          adConversionStatus.style.display = "none";
          if (bsDate && !datePattern.test(bsDate)) {
            adConversionStatus.style.display = "block";
            adConversionStatus.textContent = "Invalid format. Use YYYY-MM-DD.";
            adConversionStatus.classList.add("error");
          }
        }
      });

      let clientMap = {};
      let choicesInstance; // For Sales client dropdown

      function loadClients() {
        google.script.run.withSuccessHandler(function(clientData) {
          const select = document.getElementById("clientName");

          if (choicesInstance) {
            choicesInstance.destroy();
          }

          select.innerHTML = "";
          clientMap = {};

          const defaultOption = document.createElement("option");
          defaultOption.value = "";
          defaultOption.textContent = "-- Select Client --";
          select.appendChild(defaultOption);

          clientData.forEach(function([name, pan]) {
            if (name && pan) {
              const option = document.createElement("option");
              option.value = name;
              option.textContent = name;
              select.appendChild(option);
              clientMap[name] = pan;
            }
          });

          choicesInstance = new Choices(select, {
            searchEnabled: true,
            itemSelectText: "",
            shouldSort: false
          });

          select.addEventListener("change", function () {
            const selectedName = this.value;
            document.getElementById("panNumber").value = clientMap[selectedName] || "";
          });

        }).getClientList(); // Call getClientList for sales clients
      }

      // --- Purchase Form Logic ---
      let supplierMap = {};
      let purchaseChoicesInstance; // For Purchase supplier dropdown

      function updatePurchaseVAT() {
        let rawValue = purchaseAmountInput.value.replace(/,/g, "");
        let amount = parseFloat(rawValue);

        const selectedPurchaseType = purchaseTypeSelect.value;
        if (!isNaN(amount)) {
            if (selectedPurchaseType === "Non vat") {
                purchaseVatAmountInput.value = formatNumber(0); // VAT is 0 for Non vat
                purchaseTotalInput.value = formatNumber(amount.toFixed(2)); // Total is just the amount
            } else { // For 'Expenses', 'Fixed assets', 'Purchase'
                let vat = amount * 0.13;
                let total = amount + vat;
                purchaseVatAmountInput.value = formatNumber(vat.toFixed(2));
                purchaseTotalInput.value = formatNumber(total.toFixed(2));
            }
            purchaseAmountInput.value = formatNumber(amount.toFixed(2)); // Format for display
        } else {
            purchaseVatAmountInput.value = "";
            purchaseTotalInput.value = "";
            purchaseAmountInput.value = "";
        }
      }
      purchaseAmountInput.addEventListener("input", updatePurchaseVAT);
      purchaseTypeSelect.addEventListener("change", updatePurchaseVAT); // Recalculate if type changes

      function loadNextPurchaseSN() {
        google.script.run.withSuccessHandler(sn => {
          purchaseSnInput.value = sn;
        }).getNextPurchaseSN();
      }

      function loadSuppliers() { // This function will now call getClientList
        google.script.run.withSuccessHandler(function(supplierData) {
          console.log("Supplier data received:", supplierData); // Log received data
          const select = document.getElementById("supplierName");

          // Destroy existing Choices.js instance before re-initializing
          if (purchaseChoicesInstance) {
            purchaseChoicesInstance.destroy();
          }

          select.innerHTML = ""; // Clear previous options
          supplierMap = {};

          // Default option
          const defaultOption = document.createElement("option");
          defaultOption.value = "";
          defaultOption.textContent = "-- Select Supplier --";
          select.appendChild(defaultOption);

          // Add options dynamically
          supplierData.forEach(function([name, pan]) {
            if (name && pan) { // Ensure both name and PAN exist
              const option = document.createElement("option");
              option.value = name;
              option.textContent = name;
              select.appendChild(option);
              supplierMap[name] = pan; // Map supplier name to PAN
            }
          });

          // Initialize Choices.js
          purchaseChoicesInstance = new Choices(select, {
            searchEnabled: true,
            itemSelectText: "",
            shouldSort: false // Keep the order as it comes from the sheet
          });

          // Listen for selection changes on the Choices.js element (not the original select)
          select.addEventListener("change", function () {
            const selectedName = this.value;
            supplierPanNumberInput.value = supplierMap[selectedName] || "";
          });

        }).withFailureHandler(function(error) { // Add failure handler for debugging
            console.error("Error loading suppliers:", error);
            displayMessageBox("❌ Error loading suppliers: " + error.message, "error");
        }).getClientList(); // <--- IMPORTANT: Now calls getClientList()
      }


      purchaseForm.addEventListener("submit", function (e) {
        e.preventDefault();
        savePurchaseBtn.disabled = true;
        savePurchaseBtn.textContent = "Saving...";
        purchaseStatusMsg.style.display = "none";

        const data = {
          sn: purchaseSnInput.value,
          billNumber: purchaseBillNumberInput.value,
          dateAD: purchaseDateADInput.value,
          dateBS: purchaseDateBSInput.value,
          supplierName: supplierNameSelect.value, // Get value from select
          supplierPanNumber: supplierPanNumberInput.value, // Get value from disabled input
          purchaseType: purchaseTypeSelect.value,
          purchaseAmount: purchaseAmountInput.value,
          vatAmount: purchaseVatAmountInput.value,
          total: purchaseTotalInput.value
        };

        google.script.run
          .withSuccessHandler(() => {
            purchaseForm.reset();
            purchaseVatAmountInput.value = "";
            purchaseTotalInput.value = "";
            purchaseAmountInput.value = "";
            supplierPanNumberInput.value = ""; // Clear PAN
            savePurchaseBtn.disabled = false;
            savePurchaseBtn.textContent = "💾 Save";
            purchaseStatusMsg.textContent = "✅ Saved successfully";
            purchaseStatusMsg.style.display = "block";
            loadNextPurchaseSN();
            if (purchaseChoicesInstance) { // Destroy and reload for purchase
                purchaseChoicesInstance.destroy();
            }
            loadSuppliers(); // Reload suppliers to reset dropdown
            purchaseAdConversionStatus.style.display = "none";
            purchaseBsConversionStatus.style.display = "none";
          })
          .withFailureHandler(err => {
            displayMessageBox("❌ Couldn't save purchase data: " + err.message, "error");
            savePurchaseBtn.disabled = false;
            savePurchaseBtn.textContent = "💾 Save";
          })
          .submitPurchaseEntry(data);
      });

      window.openPurchaseModal = function () {
        purchaseModal.style.display = "block";
        loadNextPurchaseSN();
        loadSuppliers(); // Load suppliers when opening modal
        purchaseDateADInput.value = '';
        purchaseDateBSInput.value = '';
        purchaseAmountInput.value = '';
        purchaseVatAmountInput.value = '';
        purchaseTotalInput.value = '';
        purchaseTypeSelect.value = ''; // Reset select to default/empty
        supplierPanNumberInput.value = ''; // Clear PAN
        purchaseAdConversionStatus.style.display = "none";
        purchaseBsConversionStatus.style.display = "none";
      };

      window.closePurchaseModal = function () {
        purchaseModal.style.display = "none";
        purchaseStatusMsg.style.display = "none";
        purchaseForm.reset();
        purchaseVatAmountInput.value = "";
        purchaseTotalInput.value = "";
        purchaseAmountInput.value = "";
        supplierPanNumberInput.value = "";
        purchaseAdConversionStatus.style.display = "none";
        purchaseBsConversionStatus.style.display = "none";
        const msgBox = document.getElementById("messageBox");
        if (msgBox) msgBox.remove();
        if (purchaseChoicesInstance) { // Destroy Choices.js instance on close
            purchaseChoicesInstance.destroy();
        }
      };

      // Purchase Date conversion event listeners
      purchaseDateADInput.addEventListener("change", function() {
        const adDate = this.value;
        if (adDate) {
          purchaseBsConversionStatus.style.display = "block";
          purchaseBsConversionStatus.textContent = "Converting date...";
          purchaseBsConversionStatus.classList.remove("error");
          google.script.run
            .withSuccessHandler(bsDate => {
              if (bsDate) {
                purchaseDateBSInput.value = bsDate;
                purchaseBsConversionStatus.style.display = "none";
              } else {
                purchaseDateBSInput.value = "";
                purchaseBsConversionStatus.textContent = "Date not found in ADTOBS.";
                purchaseBsConversionStatus.classList.add("error");
              }
            })
            .withFailureHandler(err => {
              purchaseDateBSInput.value = "";
              purchaseBsConversionStatus.textContent = "Error converting: " + err.message;
              purchaseBsConversionStatus.classList.add("error");
            })
            .convertADtoBS(adDate);
        } else {
          purchaseDateBSInput.value = "";
          purchaseBsConversionStatus.style.display = "none";
        }
      });

      purchaseDateBSInput.addEventListener("change", function() {
        const bsDate = this.value;
        const datePattern = /^\d{4}-\d{2}-\d{2}$/; // Strictly enforce YYYY-MM-DD
        if (bsDate && datePattern.test(bsDate)) {
          purchaseAdConversionStatus.style.display = "block"; // Changed from adConversionStatus
          purchaseAdConversionStatus.textContent = "Converting date...";
          purchaseAdConversionStatus.classList.remove("error");
          google.script.run
            .withSuccessHandler(adDate => {
              if (adDate) {
                purchaseDateADInput.value = adDate; // Changed from adConversionStatus.value
                purchaseAdConversionStatus.style.display = "none";
              } else {
                purchaseDateADInput.value = "";
                purchaseAdConversionStatus.textContent = "Date not found in ADTOBS.";
                purchaseAdConversionStatus.classList.add("error");
              }
            })
            .withFailureHandler(err => {
              purchaseDateADInput.value = "";
              purchaseAdConversionStatus.textContent = "Error converting: " + err.message;
              purchaseAdConversionStatus.classList.add("error");
            })
            .convertBStoAD(bsDate);
        } else {
          purchaseDateADInput.value = "";
          purchaseAdConversionStatus.style.display = "none";
          if (bsDate && !datePattern.test(bsDate)) {
            purchaseBsConversionStatus.style.display = "block"; // Show error on BS status
            purchaseBsConversionStatus.textContent = "Invalid format. Use YYYY-MM-DD.";
            purchaseBsConversionStatus.classList.add("error");
          }
        }
      });


      // --- VAT Entry Form Logic - NEW ---
      function loadNextVatSN() {
        google.script.run.withSuccessHandler(sn => {
          vatSnInput.value = sn;
        }).getNextVatSN();
      }

      vatPanNumberInput.addEventListener("input", function() {
        const pan = this.value.trim();
        // Allow empty PAN to clear name and status
        if (pan.length === 9 && !isNaN(pan)) { // Check for 9 digits and numeric
          panCheckStatus.style.display = "block";
          panCheckStatus.textContent = "Checking PAN...";
          panCheckStatus.classList.remove("error");
          google.script.run
            .withSuccessHandler(name => {
              if (name) {
                vatNameInput.value = name;
                vatNameInput.readOnly = true; // Make name readonly if found
                panCheckStatus.style.display = "none";
              } else {
                vatNameInput.value = "";
                vatNameInput.readOnly = false; // Allow manual input if not found
                panCheckStatus.textContent = "PAN not found. Enter name manually.";
                panCheckStatus.classList.remove("error"); // Not an error, just info
              }
            })
            .withFailureHandler(err => {
              console.error("Error checking PAN:", err);
              vatNameInput.value = "";
              vatNameInput.readOnly = false;
              panCheckStatus.textContent = "Error checking PAN: " + err.message;
              panCheckStatus.classList.add("error");
            })
            .getClientNameByPan(pan); // New Apps Script function
        } else {
          vatNameInput.value = "";
          vatNameInput.readOnly = false;
          panCheckStatus.style.display = "none";
        }
      });

      vatForm.addEventListener("submit", function(e) {
        e.preventDefault();
        saveVatButton.disabled = true;
        saveVatButton.textContent = "Saving...";
        vatStatusMsg.style.display = "none";

        const data = {
          sn: vatSnInput.value,
          panNumber: vatPanNumberInput.value,
          name: vatNameInput.value
        };

        // Basic validation for VAT entry
        if (!data.panNumber || data.panNumber.length !== 9 || isNaN(data.panNumber)) {
            displayMessageBox("❌ Please enter a valid 9-digit PAN number.", "error");
            saveVatButton.disabled = false;
            saveVatButton.textContent = "💾 Save Data";
            return;
        }
        if (!data.name) {
            displayMessageBox("❌ Please enter a Name for the PAN entry.", "error");
            saveVatButton.disabled = false;
            saveVatButton.textContent = "💾 Save Data";
            return;
        }


        google.script.run
          .withSuccessHandler(() => {
            vatForm.reset();
            vatNameInput.readOnly = false; // Reset name input to editable
            saveVatButton.disabled = false;
            saveVatButton.textContent = "💾 Save Data";
            vatStatusMsg.textContent = "✅ VAT entry saved!";
            vatStatusMsg.style.display = "block";
            loadNextVatSN();
            panCheckStatus.style.display = "none"; // Clear PAN status
          })
          .withFailureHandler(err => {
            displayMessageBox("❌ Couldn't save VAT data: " + err.message, "error");
            saveVatButton.disabled = false;
            saveVatButton.textContent = "💾 Save Data";
          })
          .submitVatEntry(data); // New Apps Script function
      });

      window.openVatModal = function () {
        vatModal.style.display = "block";
        loadNextVatSN();
        vatPanNumberInput.value = ''; // Clear previous input
        vatNameInput.value = ''; // Clear previous input
        vatNameInput.readOnly = false; // Ensure it's editable initially
        panCheckStatus.style.display = "none"; // Clear status message
        vatStatusMsg.style.display = "none"; // Clear save status message
      };

      window.closeVatModal = function () {
        vatModal.style.display = "none";
        vatForm.reset();
        vatNameInput.readOnly = false;
        panCheckStatus.style.display = "none";
        vatStatusMsg.style.display = "none";
        const msgBox = document.getElementById("messageBox");
        if (msgBox) msgBox.remove();
      };


      // Global click handler for modals and message box
      window.onclick = function (event) {
        const salesModal = document.getElementById("salesModal");
        const purchaseModal = document.getElementById("purchaseModal");
        const vatModal = document.getElementById("vatModal"); // Include VAT modal
        const msgBox = document.getElementById("messageBox");

        if (event.target === salesModal) {
          closeSalesModal();
        }
        if (event.target === purchaseModal) {
          closePurchaseModal();
        }
        if (event.target === vatModal) { // Handle VAT modal close
          closeVatModal();
        }
        if (msgBox && event.target === msgBox) {
          msgBox.remove();
        }
      };

      // Custom Message Box function (replaces alert())
      function displayMessageBox(message, type = "info") {
          let messageBox = document.getElementById("messageBox");
          if (!messageBox) {
              messageBox = document.createElement("div");
              messageBox.id = "messageBox";
              messageBox.style.cssText = `
                  position: fixed;
                  top: 50%;
                  left: 50%;
                  transform: translate(-50%, -50%);
                  background-color: white;
                  padding: 20px 30px;
                  border-radius: 10px;
                  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                  z-index: 1000;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  max-width: 400px;
                  text-align: center;
              `;
              document.body.appendChild(messageBox);
          }

          messageBox.innerHTML = `
              <p style="margin-bottom: 15px; font-size: 16px; color: ${type === 'error' ? '#dc2626' : '#1e3a8a'}; font-weight: 600;">${message}</p>
              <button onclick="document.getElementById('messageBox').remove()" style="
                  padding: 8px 20px;
                  background-color: #2563eb;
                  color: white;
                  border: none;
                  border-radius: 5px;
                  cursor: pointer;
                  font-size: 14px;
              ">OK</button>
          `;
          messageBox.style.display = "flex";
      }

    }); // End DOMContentLoaded
</script>

</body>

</body>
</html>
